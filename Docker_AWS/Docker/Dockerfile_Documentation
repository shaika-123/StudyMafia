

# **üìò Dockerfile Documentation (Line-by-Line Explanation + Notes + Caution Points)**

This document explains each part of the Dockerfile used to build and run a production Next.js application using **Node 18 Alpine + Supervisor**.

---

# **1Ô∏è‚É£ Base Image**

```dockerfile
FROM node:18-alpine AS base
```

* Uses **Node 18 Alpine**, a lightweight Linux distribution.
* Smaller image size ‚Üí faster download & deployment.
* Good for production environments.

---

# **2Ô∏è‚É£ Install Required System Packages**

```dockerfile
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    supervisor \
    wget \
    libc6-compat \
    && rm -rf /var/cache/apk/*
```

### What these packages are used for:

* **python3 / make / g++** ‚Üí Needed by npm packages that compile native binaries (e.g., bcrypt, sharp, prisma).
* **supervisor** ‚Üí Used to run and restart Next.js automatically inside the container.
* **wget** ‚Üí Used by the healthcheck command.
* **libc6-compat** ‚Üí Provides compatibility libraries needed by some Node modules.
* `--no-cache` ‚Üí Avoids storing apk cache (reduces image size).

### ‚ùó Common mistakes:

* Missing these build tools causes `npm install` failures.
* Removing tools after build is optional but reduces final image size.

---

# **3Ô∏è‚É£ Build-Time Environment Variables**

```dockerfile
ARG SKIP_LINT_AND_TYPECHECK=1
ENV SKIP_LINT_AND_TYPECHECK=$SKIP_LINT_AND_TYPECHECK
ENV NEXT_DISABLE_ESLINT=1
ENV NEXT_DISABLE_TYPECHECK=1
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS=--max-old-space-size=4096
```

### Why these exist:

* Skip linting & typechecking ‚Üí faster builds, fewer failures.
* Disable Next.js telemetry ‚Üí avoid sending data to Vercel.
* Increase Node.js memory (`4096 MB`) ‚Üí prevents out-of-memory crashes during build.

### ‚ùó Caution:

* Skipping type-checking means build will not catch TypeScript errors.
* If your app relies on these checks, remove these settings.

---

# **4Ô∏è‚É£ Set Working Directory**

```dockerfile
WORKDIR /app
```

* All future commands run inside `/app`.
* Keeps the container organised.

---

# **5Ô∏è‚É£ Copy Application Code**

```dockerfile
COPY ./akshayapatra .
```

* Copies your entire project directory (`akshayapatra`) into the container.

### ‚ùó Common issues:

* Wrong folder path ‚Üí build will fail (`package.json` not found).
* Ensure `.dockerignore` excludes unnecessary items (node_modules, .git).

---

# **6Ô∏è‚É£ Install Dependencies**

```dockerfile
RUN npm install
```

* Installs npm packages.
* Uses the installed build tools from earlier to compile native modules.

### ‚ùó Possible problems:

* Missing `package-lock.json` ‚Üí inconsistent versions.
* Private npm packages ‚Üí require `.npmrc`.

---

# **7Ô∏è‚É£ Build Next.js Application**

```dockerfile
RUN npm run build
```

* Creates a production build inside `.next`.
* Uses the environment variables defined earlier.

### ‚ùó Build may fail if:

* Required environment variables are missing.
* Prisma, sharp, or native modules have incompatible binaries.

---

# **8Ô∏è‚É£ Add Supervisor Configuration**

```dockerfile
RUN mkdir -p /etc/supervisor/conf.d
COPY <<EOF /etc/supervisor/conf.d/supervisord.conf
...
EOF
```

Supervisor is used to keep the Next.js process alive.

### Inside the supervisor config:

```ini
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[program:nextjs]
command=npm start
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nextjs.out.log
stderr_logfile=/var/log/supervisor/nextjs.err.log
environment=NODE_ENV=production
```

### Why supervisor?

* Ensures Node never stops.
* If Next.js crashes ‚Üí supervisor restarts automatically.
* Allows log file creation inside `/var/log/supervisor`.

### ‚ùó Note:

* Not required if using PM2, but supervisor is lighter and commonly used in Alpine images.

---

# **9Ô∏è‚É£ Create Supervisor Log Directories**

```dockerfile
RUN mkdir -p /var/log/supervisor /var/run
```

* Ensures supervisor has required folders.
* Avoids runtime errors (`cannot find log directory`).

---

# **üîü Expose Port**

```dockerfile
EXPOSE 3000
```

* Informs Docker that the app listens on port 3000.
* Does **not** do port mapping by itself ‚Äî mapping happens during `docker run -p`.

---

# **1Ô∏è‚É£1Ô∏è‚É£ Health Check**

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1
```

### Purpose:

* Ensures container is alive and responding.
* AWS ECS/EKS uses this to restart unhealthy containers.

### Requirements:

* Your app must have a route: `/api/health`.

### ‚ùó Mistake to avoid:

If `/api/health` does not exist ‚Üí AWS marks container UNHEALTHY ‚Üí keeps restarting repeatedly.

---

# **1Ô∏è‚É£2Ô∏è‚É£ Final Command (Start Container)**

```dockerfile
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
```

### This is what happens when the container starts:

1. Supervisor runs.
2. Supervisor starts `npm start`.
3. App keeps running with auto-restart capability.

---

# **üìå Important Notes & Common Mistakes Summary**

### üî¥ Common mistakes to avoid:

1. **Wrong COPY path** ‚Üí container cannot find project files.
2. **Not using .dockerignore** ‚Üí extremely slow builds.
3. **Missing system libraries for sharp/prisma** ‚Üí build failures.
4. **Wrong healthcheck path** ‚Üí AWS keeps restarting container.
5. **Not passing required environment variables** during build.
6. **Incorrect supervisor config path** ‚Üí app won't start.
7. **Exposing the wrong port** ‚Üí container runs but unreachable.

---

# **üìÑ Want this in PDF or Markdown format?**

I can convert this entire documentation into:

‚úÖ PDF
‚úÖ Markdown (README)
‚úÖ Plain-text cheat sheet

Just tell me the format you want.
